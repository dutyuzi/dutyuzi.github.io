---
layout:     post
title:      "在浏览器中输入URL到整个页面显示在用户面前时这个过程中到底发生了什么"
subtitle:   "What's going on in the browser when you enter a URL to the entire page and display it in front of the user"
date:        2017/06/11  15:01:00 
author:     "MaJ"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - other
---
### 背景知识
---
**TCP/IP 参考模型**

![img](/img/TCP.jpg)

如上图所示，TCP/IP参考模型分为四层：应用层、运输层、网络层和接口层。浏览器所完成的工作就属于应用层的范畴。

### 1 DNS域名解析
当在浏览器中输入	www.baidu.com 时，浏览器必须知道所请求服务器的IP地址，才能向该IP地址发送请求。DNS（Domain Name System）提供将域名转换成其服务器的IP地址的服务。

DNS查询有两种方式：**递归和迭代**。DNS客户端设置使用的DNS服务器一般都是递归服务器，它负责全权处理客户端的DNS查询请求，直到返回最终结果。而DNS服务器之间一般采用迭代查询方式。

以查询www.baidu.com为例：
客户端发送查询报文"query baidu.com"至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。
如果记录老化或不存在，则

1、DNS服务器向根域名服务器发送查询报文"query baidu.com"，根域名服务器返回.com域的权威域名服务器地址，这一级首先会返回的是顶级域名的权威域名服务器。

2、DNS服务器向.com域的权威域名服务器发送查询报文"query baidu.com"，得到baidu.com域的权威域名服务器地址。

### 2 封装HTTP请求
可以看到，这个请求里面包含了请求的方法GET，请求的路径“/”，请求的主机名，客户机的类型以及一些其他的信息。

	GET / HTTP/1.1
	Host: baidu.com
	User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36
	Accept-Encoding: gzip, deflate
	Connection: Keep-Alive
	[其他头部]

“其他头部”包含了一系列的由冒号分割开的键值对，它们的格式符合HTTP协议标准，它们之间由一个换行符分割开来


### 3 建立TCP连接
TCP是面向连接的，在实际发送数据之前，客户端和服务器需要建立起一个TCP连接。

当浏览器得到了目标服务器的 IP 地址，以及 URL 中给出来端口号（http 协议默认端口号是 80， https 默认端口号是 443），它会调用系统库函数 socket ，请求一个 TCP流套接字。

TCP连接的建立过程如下图所示。首先，TCP先发送一个创建连接的SYN请求，告诉服务器主机“我想和你创建一条TCP连接”。当服务器主机收到SYN请求后，如果其所请求的端口号正在等待连接，则会为这一条TCP连接分配资源，并发送一个SYNACK报文段作为应答。客户主机收到SYNACK报文段后，客户机也为该连接分配资源。此时，连接已经建立起来了。客户主机还会向服务器主机发送另一个报文段，对允许连接的报文段进行确认。这就是有名的“三次握手”。

![img](/img/3hand.png)

wireshark抓包连接过程

![img](/img/3handws.jpg)

简单讲：首先Client端发送连接请求报文，Server段接受连接后回复ACK报文，并为这次连接分配资源。Client端接收到ACK报文后也向Server段发生ACK报文，并分配资源，这样TCP连接就建立了。

### 4 发送请求
TCP报文段的格式如下图所示

![img](/img/TCPmessage.jpg)

目的端口和源端口号是为了在多路复用和多路分解时选择套接字时使用的。
数据序号和确认序号是为了传输数据的完整性和顺序而设置的。
用户数据这一个字段就存储了应用层生成的HTTP报文。
ACK、SYN和FIN是在建立连接和关闭连接时使用。

### 5 路由寻址

现在两个端系统已经建立起了连接，请求也被传送到客户端主机的网络层。网络层是协议栈中最复杂的层次，应用层和传输层只运行在两个端系统，而网络层不仅运行在端系统，还运行在各个中间节点上。
我们先来看看IP数据报的格式。

![img](/img/IPmessage.jpg)

网络层实现的最重要的功能时路由选择，具体来讲就是怎么把这个IP数据报文经过网络中的若干路由，发送到目的地址。

![img](/img/router.jpg)

IP路由选择是逐跳（hop-to-hop）进行的。IP并不知道从H1到H2的完整路径。所有的IP选择只为数据报提供下一站的IP地址。路由选择机制的基础是在每一台主机和路由器里都存储着一张路由表。路由表的每一项包含了目的主机IP地址、下一跳路由器（或主机）的IP地址、相对应的网络接口以及其他必要的信息。当一个数据报到达一个节点时，IP路由选择完成以下工作：搜索路由表，寻找能与目的主机IP地址完全匹配的表目。如果找到，则把报文发送给下一跳节点。搜索路由表，寻找能与目标网络号相匹配的表目。如果找到，则把报文发送给下一跳节点。搜索路由表，寻找“默认”的表目。如果找到，则把报文发送给下一跳节点。如果上面这些步骤都没有成功，那么该数据报就不能被传送。如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。在我们的例子中，H1通过搜索自己的路由表将数据报转发给R1，R1根据路由表转发给R2，最后到达H2。


### 6 HTTP服务器处理

HTTPD(HTTP Daemon)在服务器端处理请求/响应。最常见的 HTTPD 有 Linux 上常用的 Apache 和 nginx，以及 Windows 上的 IIS。



- HTTP 服务器接收请求，服务器把请求拆分为以下几个参数：

 1. HTTP 请求方法(GET, POST, HEAD, PUT, DELETE, CONNECT, OPTIONS, 或者 TRACE)。直接在地址栏中输入 URL 这种情况下，使用的是 GET 方法
 2. 域名：baidu.com
 3. 请求路径/页面：/ (我们没有请求baidu.com下的指定的页面，因此 / 是默认的路径)

- 服务器验证其上已经配置了 baidu.com 的虚拟主机

- 服务器验证 baidu.com 接受 GET 方法

- 服务器验证该用户可以使用 GET 方法(根据 IP 地址，身份信息等)

- 如果服务器安装了 URL 重写模块（例如 Apache 的 mod_rewrite 和 - IIS 的 URL Rewrite），服务器会尝试匹配重写规则，如果匹配上的话，服务器会按照规则重写这个请求

- 服务器根据请求信息获取相应的响应内容，这种情况下由于访问路径是 "/" ,会访问首页文件（你可以重写这个规则，但是这个是最常用的）。

- 服务器会使用指定的处理程序分析处理这个文件，假如 baidu 使用 PHP，服务器会使用 PHP 解析 index 文件，并捕获输出，把 PHP 的输出结果返回给请求者。

**总结以上过程**：
目标主机收到了请求后，自底向上地对该请求进行处理。链路层把数据报传给网络层，网路层将TCP数据段通过对应的Socket传给应用程序。应用程序处理请求后产生一个应答的HTTP报文，又经过了一层层的封装、一跳跳的传输到达了源主机。

### 7 浏览器解析渲染

当服务器提供了资源之后（HTML，CSS，JS，图片等），浏览器会执行下面的操作：

解析 —— HTML，CSS，JS

渲染 —— 构建 DOM 树 -> 渲染 -> 布局 -> 绘制

### 8 关闭TCP连接

当传输层收到了应答之后，就要关闭这条连接了。但是，又不能悄悄地自己关了，目标主机那边还不知道你要不要关闭呢。于是乎，就有了对应创建TCP连接“三次握手”的关闭TCP连接“四次挥手”。如下图所示，客户端向服务器发出了FIN报文段，服务器收到后，回复一个ACK应答。然后，服务器也向客户端发送一个FIN报文段，随后关闭了服务器端的连接，释放了资源。当客户端收到之后，又向服务器回复一个ACK应答。过了一段计时等待，客户端也关闭了连接，释放资源。**这一段计时等待的时间是为了客户端重传最后的ACK防止其丢失**。

![img](/img/TCPclose.png)

wireshark抓包关闭过程

![img](/img/４handws.jpg)

## 参考
[TCP/IP协议族](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)

[在浏览器地址栏输入一个URL后回车，背后会进行哪些技术步骤？](https://www.zhihu.com/question/34873227/)

[当···时发生了什么？](https://github.com/skyline75489/what-happens-when-zh_CN#id6)

[TCP协议中的三次握手和四次挥手(图解)](http://blog.csdn.net/whuslei/article/details/6667471/)
